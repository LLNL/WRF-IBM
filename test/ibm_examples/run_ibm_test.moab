#!/bin/csh
### Change the machine partition, if necessary
#MSUB -l partition=quartz
### Change the queue, if necessary
#MSUB -q pbatch
### You may need to change the walltime limit depending on machine and queue
#MSUB -l walltime=01:00:00
### Change the number of nodes to whatever you want / have
### NOTE: you must also change the argument for the srun command(s) below
#MSUB -l nodes=2
#MSUB -l gres=ignore
#MSUB -N ibm_test
### Change the account below to what you have access to
#MSUB -A gsmisc
#MSUB -V
# ----------------------------------------------------------------
# Generated by David Wiersema's python scripts
# Created:  2019/08/05
# Modified: 2020/04/06
# ----------------------------------------------------------------
# Set WRF to the directory where your WRF code is located
set WRF = /g/g14/wiersema/projects/wrf_ibm
# Set SCRATCH to the directory where you want to run
set SCRATCH = /p/lustre1/wiersema/wrf_ibm/ibm_tests
# ----------------------------------------------------------------
echo "RUNNING JOB ON `/bin/hostname` AT `date`"
if ( -d $WRF ) then
    echo "$WRF/ DIRECTORY EXISTS"
else
    echo "$WRF DIRECTORY DOES NOT EXIST"
    goto error
endif
endif
if ( -d $SCRATCH ) then
    echo "$SCRATCH/ DIRECTORY EXISTS"
else
    echo "$SCRATCH DIRECTORY DOES NOT EXIST"
    goto error
endif
cd $SCRATCH/
if ( -e $WRF/main/wrf.exe ) then
    ln -sf $WRF/main/wrf.exe $SCRATCH
else
    echo "ERROR: $WRF/main/wrf.exe DOES NOT EXIST"
    goto error
endif
if ( -e $WRF/main/ideal.exe ) then
    ln -sf $WRF/main/ideal.exe $SCRATCH
else
    echo "ERROR: $WRF/main/ideal.exe DOES NOT EXIST"
    goto error
endif
if ( -e $SCRATCH/namelist.input ) then
    echo "USING $SCRATCH/namelist.input"
else
    echo "ERROR: $SCRATCH/namelist.input DOES NOT EXIST"
    goto error
endif
if ( -e $SCRATCH/input_sounding ) then
    echo "USING $SCRATCH/input_sounding"
else
    echo "ERROR: $SCRATCH/input_sounding DOES NOT EXIST"
    goto error
endif
./ideal.exe
mv rsl.out.0000 rsl.out.ideal
if ( -e $SCRATCH/wrfinput_d01 ) then
    echo "$SCRATCH/wrfinput_d01 EXISTS"
else
    echo "$SCRATCH/wrfinput_d01 DOES NOT EXIST"
    goto error
endif
echo "RUNNING WRF ($WRF) IN `pwd`"
# If necessary, change the number of cores used in the line below
srun -n 72 ./wrf.exe
goto finished
finished:
    echo "FINISHED JOB ON `/bin/hostname` AT `date`"
    exit 0
error:
    echo "ERRORS ENCOUNTERED AT `date`"
    exit 1
